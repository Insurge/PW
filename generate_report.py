#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Генерація markdown звіту про кореляційний аналіз
"""

import pandas as pd
from pathlib import Path
from datetime import datetime

output_dir = Path('outputs')
alpha = 0.05

# Завантаження результатів
try:
    df = pd.read_csv(output_dir / 'synthetic_data.csv')
    normality_df = pd.read_csv(output_dir / 'normality_summary.csv')
    corr_listwise = pd.read_csv(output_dir / 'correlations_listwise.csv')
    
    print("Генерація звіту...")
    
    # Знайти основну пару
    main_pair = corr_listwise[
        (corr_listwise['variable_x'] == 'sleep_hours') & 
        (corr_listwise['variable_y'] == 'productivity_score')
    ]
    
    if len(main_pair) == 0:
        main_pair = corr_listwise.iloc[[0]]  # Якщо не знайдено, взяти першу
    
    row = main_pair.iloc[0]
    
    # Формування звіту
    report = f"""# Звіт про виконання комп'ютерного практикуму №1
## Метод кореляційного аналізу даних

---

## 1. ВСТУПНА ЧАСТИНА

**ВНЗ:** [Назва навчального закладу]  
**Кафедра:** [Назва кафедри]  
**Дисципліна:** Інтелектуальний аналіз даних  
**№ роботи:** 1  
**Тема:** Метод кореляційного аналізу даних  
**Група:** [Номер групи]  
**Виконав:** [ПІБ студента]  
**Викладач:** [ПІБ викладача]  

---

## 2. МЕТА РОБОТИ

Оволодіння методами кореляційного аналізу для дослідження статистичних зв'язків між змінними, визначення сили та напрямку зв'язку, перевірки статистичної значущості кореляційних коефіцієнтів.

---

## 3. ЗАВДАННЯ

1. Оволодіти методами кореляційного аналізу (коефіцієнти Пірсона та Спірмена).
2. Виконати кореляційний аналіз між змінними, визначити силу та напрямок зв'язку, перевірити статистичну значущість.

---

## 4. МЕТОДИКА

### 4.1. Вибір методу кореляції

Для кожної пари змінних метод кореляції обирався за наступними правилами:

- **Коефіцієнт Пірсона** (параметричний): якщо обидві змінні мають нормальний розподіл
- **Коефіцієнт Спірмена** (непараметричний, ранговий): якщо хоча б одна змінна не має нормального розподілу

### 4.2. Перевірка нормальності

Для перевірки нормальності розподілу використовувався:
- **Тест Shapiro-Wilk** (для вибірок n ≤ 5000)
- **Тест Kolmogorov-Smirnov** (для вибірок n > 5000)

Гіпотеза H₀: дані мають нормальний розподіл.  
Рівень значущості: α = {alpha}

### 4.3. Обробка пропущених значень

Використано підхід **Listwise deletion** (повне виключення рядків з пропусками).

### 4.4. Інтерпретація сили зв'язку

| |r| | Інтерпретація |
|------|---------------|
| 0.75-1.00 | Дуже високий |
| 0.50-0.74 | Високий |
| 0.25-0.49 | Середній |
| 0.00-0.24 | Слабкий |

---

## 5. РЕЗУЛЬТАТИ

### 5.1. Характеристика даних

- **Кількість спостережень:** {len(df)}
- **Кількість змінних:** {len(df.columns)}
- **Змінні:** {', '.join(df.columns.tolist())}

### 5.2. Результати тестів нормальності

```
{normality_df.to_string(index=False)}
```

### 5.3. Результати кореляційного аналізу

#### Топ-5 найсильніших кореляцій:

```
{corr_listwise.nlargest(5, 'coefficient')[['variable_x', 'variable_y', 'method', 'coefficient', 'p_value', 'strength_label']].to_string(index=False)}
```

Повні результати збережено у файлі: `correlations_listwise.csv`

### 5.4. Візуалізації

Створено наступні графіки:

1. **Діаграми розсіювання для ключових пар змінних:**
   - `scatter_sleep_hours_vs_productivity_score.png`
   - `scatter_steps_per_day_vs_weight_kg.png`
   - `scatter_calories_intake_vs_weight_kg.png`
   - `scatter_caffeine_mg_vs_productivity_score.png`

2. **Матриця кореляцій:**
   - `correlation_matrix.png`

![Матриця кореляцій](correlation_matrix.png)

---

## 6. ВИСНОВКИ

1. **Основний результат:** Виявлено {row['strength_label']} зв'язок між {row['variable_x']} та {row['variable_y']} (r = {row['coefficient']:.4f}, p = {row['p_value']:.4f}).

2. **Метод аналізу:** На основі тестів нормальності для аналізу використовувався коефіцієнт {row['method']}.

3. **Статистична значущість:** Кореляція є {'статистично значущою' if row['p_value'] < alpha else 'статистично незначущою'} на рівні α = {alpha}.

4. **Інтерпретація:** {'Виявлений зв\'язок вказує на те, що зі збільшенням однієї змінної спостерігається ' + ('підвищення' if row['coefficient'] > 0 else 'зниження') + ' іншої змінної.'}.

5. **Практичне значення:** Отримані результати мають практичне значення для розуміння взаємозв'язків між досліджуваними змінними.

---

## 7. ВІДПОВІДІ НА КОНТРОЛЬНІ ЗАПИТАННЯ

### 7.1. Які задачі вирішує кореляційний аналіз?

Кореляційний аналіз вирішує наступні задачі:
- Визначення наявності статистичного зв'язку між змінними
- Оцінка сили та напрямку (прямий/зворотний) зв'язку
- Перевірка статистичної значущості виявлених зв'язків
- Відбір змінних для подальшого регресійного аналізу
- Виявлення мультиколінеарності у даних

### 7.2. Як знайти коефіцієнт кореляції?

**Коефіцієнт Пірсона:**
```
r = Σ[(xi - x̄)(yi - ȳ)] / √[Σ(xi - x̄)² × Σ(yi - ȳ)²]
```

**Коефіцієнт Спірмена:**
```
ρ = 1 - [6Σdi²] / [n(n² - 1)]
де di - різниця рангів
```

У Python використовуються функції `pearsonr()` та `spearmanr()` з бібліотеки `scipy.stats`.

### 7.3. Які типи коефіцієнтів кореляції існують?

Основні типи коефіцієнтів кореляції:
1. **Коефіцієнт Пірсона** (r) - параметричний метод для лінійних зв'язків між нормально розподіленими змінними
2. **Коефіцієнт Спірмена** (ρ) - непараметричний ранговий метод для монотонних зв'язків
3. **Коефіцієнт Кендалла** (τ) - непараметричний метод на основі конкордантності
4. **Точковий бісеріальний** - для зв'язку між безперервною та бінарною змінними
5. **Фі-коефіцієнт** - для двох бінарних змінних

### 7.4. Різниця між прямою та зворотною кореляцією?

- **Пряма (позитивна) кореляція** (r > 0): Зі збільшенням однієї змінної збільшується інша. Наприклад, зв'язок між годинами навчання та оцінками.

- **Зворотна (негативна) кореляція** (r < 0): Зі збільшенням однієї змінної зменшується інша. Наприклад, зв'язок між кількістю пропусків занять та успішністю.

- **Відсутність кореляції** (r ≈ 0): Змінні не пов'язані лінійно.

### 7.5. Як перевіряється значущість коефіцієнта кореляції?

Перевірка значущості здійснюється за допомогою статистичного тесту:

1. **Формулювання гіпотез:**
   - H₀: ρ = 0 (кореляція відсутня)
   - H₁: ρ ≠ 0 (кореляція присутня)

2. **Розрахунок p-значення** на основі t-статистики:
   ```
   t = r√(n-2) / √(1-r²)
   ```
   де n - кількість спостережень

3. **Прийняття рішення:**
   - Якщо p < α (наприклад, 0.05), відхиляємо H₀ - кореляція значуща
   - Якщо p ≥ α, не відхиляємо H₀ - кореляція незначуща

Рівні значущості:
- p < 0.05 (*) - значуща на рівні 5%
- p < 0.01 (**) - значуща на рівні 1%

---

## 8. СПИСОК ЗГЕНЕРОВАНИХ ФАЙЛІВ

### Дані:
- `synthetic_data.csv` - згенеровані дані

### Результати аналізу:
- `normality_summary.csv` - результати тестів нормальності
- `correlations_listwise.csv` - кореляції (listwise підхід)
- `correlation_matrix.csv` - матриця кореляцій

### Візуалізації:
- `scatter_sleep_hours_vs_productivity_score.png`
- `scatter_steps_per_day_vs_weight_kg.png`
- `scatter_calories_intake_vs_weight_kg.png`
- `scatter_caffeine_mg_vs_productivity_score.png`
- `correlation_matrix.png`

### Звіти:
- `report_draft.md` - цей звіт

---

**Дата виконання:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
"""

    # Збереження звіту
    report_path = output_dir / 'report_draft.md'
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(report)
    
    print(f"[OK] Звіт згенеровано: {report_path}")
    print(f"\nЗвіт містить:")
    print("  - Вступну частину")
    print("  - Мету та завдання")
    print("  - Методику")
    print("  - Результати з таблицями")
    print("  - Висновки")
    print("  - Відповіді на контрольні запитання")
    
    # Також створимо текстовий висновок
    conclusion_text = f"""
ВИСНОВОК ПО ОСНОВНІЙ ПАРІ ЗМІННИХ
{'=' * 80}

Змінні: {row['variable_x']} ↔ {row['variable_y']}

Результати аналізу:
  • Метод: {row['method']} (обрано на основі тестів нормальності)
  • Коефіцієнт кореляції: r = {row['coefficient']:.4f}
  • P-значення: p = {row['p_value']:.4f}
  • Кількість спостережень: n = {int(row['n'])}
  • Сила зв'язку: {row['strength_label']}

Статистичний висновок:
На рівні значущості α = {alpha}, гіпотезу H₀: ρ = 0 (відсутність кореляції) 
{'ВІДХИЛЕНО' if row['p_value'] < alpha else 'НЕ ВІДХИЛЕНО'}.

Інтерпретація:
Було виявлено {row['strength_label']} зв'язок між {row['variable_x']} та 
{row['variable_y']} (r = {row['coefficient']:.4f}, p = {row['p_value']:.4f}, n = {int(row['n'])}).

{'Це означає, що зі збільшенням однієї змінної спостерігається тенденція до ' + ('підвищення' if row['coefficient'] > 0 else 'зниження') + ' іншої змінної.'}
Зв'язок є статистично значущим, що свідчить про наявність реальної асоціації 
між цими змінними в досліджуваній популяції.

{'=' * 80}
"""
    
    conclusion_path = output_dir / 'main_pair_conclusion.txt'
    with open(conclusion_path, 'w', encoding='utf-8') as f:
        f.write(conclusion_text)
    
    print(f"[OK] Висновок збережено: {conclusion_path}")
    
except Exception as e:
    print(f"Помилка: {e}")
    import traceback
    traceback.print_exc()

